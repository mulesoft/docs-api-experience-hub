= Troubleshooting Single Sign-On Errors
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images/

The following topics provide possible causes for single sign-on (SSO) issues and describe how to troubleshoot:

== Missing Redirect URI

A 400 error occurs when logging in to the portal with SSO if the external identity provider application doesnâ€™t have the proper redirect URIs defined.

To troubleshoot this issue, ensure all of the necessary redirect URIs are included:

* https://login.salesforce.com/services/authcallback/${salesforceOrganizationId}/${authProviderURLSuffix}
* https://${domain}.my.salesforce.com/services/authcallback/${authProviderURLSuffix}
* https://${domain}.my.site.com/aeh/services/authcallback/${authProviderURLSuffix}

To get the following redirect URIs:

* salesforceOrganizationId: In Salesforce, go to *Setup > Company Information*.
* authProviderURLSuffix: In Salesforce, go to *Setup > Auth Providers* and select your auth provider URL Suffix.
* domain: In Salesforce, go to *Setup > My Domain > Current My Domain URL*.

== Insufficient Privileges

An insufficient privileges error occurs after logging in to the portal using SSO.

To troubleshoot this issue, publish the portal from the Builder.

. Navigate to *Anypoint Platform*, enter your username and password, and  click *Sign in*.
. From Anypoint Platform, select *API Experience Hub* from the list of products. 
. Go to From the *Manage your API portal* page, click *Preview and publish your portal.
. Click *Publish*. 

== API Carousel Not Loading

After logging in to the portal successfully, you cannot see the APIs in the API Carousel.

A few issues can cause this error to occur:

* The external identity provider group mapping is missing from Access Management.
* The *Auth provider Default Scopes* field is not configured properly.

=== External Identity Provider Group Mapping is Missing or Misconfigured

To troubleshoot this issue, add the external identity provider group mapping in Access Management for the portal member user:

. Go to *Access Management* > *Teams*.
. Click *AEH Portal Guests* and click *AEH Portal Members*.
. Click *External IdP Groups*.
. From *Group Name*, enter *AEH Members*.
. From *Provider Name*, select the name of the corresponding Salesforce identity provider.
. From *Type*, select *Member* and click *Add*.

== Auth Provider Default Scopes Field Is Not Configure Properly

To troubleshoot this issue, ensure the *Default Scopes* field has the *profile openid email groups* value.

. In *Salesforce*, go to *Setup*.
. In the *Quick Find* box, enter `Auth`, and then select *Auth Providers*.
. Click *Edit*.
. In the *Auth Provider Detail* section, enter `*profile openid email groups*`.
. Click *Save*.

== Cannot Log In

When trying to log in to the portal with an identity provider, you see a *Problem Logging In* error that the third-party identifier cannot be be found. An incorrect portal URL can cause issues logging in.

To troubleshoot this issue, ensure that the URL is properly configured. For Okta, the `/userinfo` part of the URL path must be lowercase.

== No Option to Log In to the Portal Through the Identity Provider 

There is no option to log in to the portal through the identity provider after the identity provider is configured, mapped, and enabled in the API Experience Hub UI. 

A few issues can cause this error to occur:

Currently, the information entered when setting up SSO for the portal cannot be verified from API Experience Hub. 

The following issues prevent end users from logging in to the portal using the identity provider:

* The *Auth. Provider* page has incorrect information for configuring an authentication provider for Salesforce. 
* The wrong Anypoint identity provider is mapped in the API Experience Hub UI.
* Users are assigned to the wrong user group in Access Management or not added.

To troubleshoot this issue, review the information entered in the *Auth. Provider* page, Access Management, and API Experience Hub UI.

To review and change information entered in the *Auth. Provider* page:

. In *Salesforce*, go to *Setup*.
. In the *Quick Find* box, enter `Auth`, and then select *Auth. Providers*.
. Select the auth provider that was configured for Salesforce.
. Review the information to ensure the following fields are correct:
+
[%header,cols="1a,2a"]
|===
|Field|Value
|*Provider Type*|*OpenID Connect* 
|*Name*| Enter a name for the provider.
|*Consumer Key* |Enter the client ID from the identity provider.
|*Consumer Secret*|Enter the client secret from the identity provider.
|*Authorize Endpoint URL*| Enter `https://{domainofOktaorg}.okta.com/oauth2/v1/authorize*`.
|*Token Endpoint URL* |Enter `https://{domainofOktaorg}.okta.com/oauth2/v1/token`.
|*User Info Endpoint URL*|Enter `https://{domainofOktaorg}.okta.com/oauth2/v1/userinfo``.
|*Default Scopes*  |*profile openid email groups* 
|*Registration handler*  |*AEHPortalRegistrationHandler* 
|*Execute Registration As*  |Select an administrator user. 
|===
+
Here is an example of the *Auth. Provider* page:
+
image::aeh-salesforce-auth-provider.png[Salesforce Auth. Provider example]

. To make changes, click *Edit* and then *Save*.

To review and change the Anypoint identity provider mapped in the API Experience Hub UI:

. Go to *API Experience Hub > User management*.
. From the *User management* page, select the *Login settings* tab.
. From the *Single sign-on (SSO)* section, scroll down to step 2 *Add Salesforce identity providers*.
. Click *Select identity provider* and select an option from the drop-down menu. 
. Click *+ Add identity provider*.
. Move the slider to *Enabled*.

To review the user group for the identity provider:

. Go to *Access Management* > *Teams*.
. Click *AEH Portal Members*.
. Click *External IdP Groups*.
. Ensure that the group name is *AEH Portal Members*.
. If the group is not listed, add the group.
+
image::aeh-sso-access-mgmt-ext-idp-groups.png[Access Management group mapping]
. Click *Save Changes*.
+
The SSO users associated with the group you designated are assigned to the team. 





