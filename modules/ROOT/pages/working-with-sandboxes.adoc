=  Working With Sandboxes
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

Use Salesforce sandbox organizations to test your portal in a sandbox environment under the same conditions as your production environment. API Experience Hub enables you to manage separate deployment environments for your API portal. You can connect to multiple Salesforce sandbox organizations and switch between them. Manage Salesforce organizations from the *Manage your API portal* page by selecting sandbox environments that are available in the current Salesforce connection.  

== Before You Begin
Ensure that you have sandbox organizations already set up. For more information about creating sandboxes, see https://help.salesforce.com/s/articleView?id=sf.data_sandbox_create.htm&type=5[Create a Sandbox] in the Salesforce documentation.

== Manage Salesforce Organization Connections

. In the *Manage your API portal* page, click the connection control. 
+
image::aeh-org-switcher.png["Connection control",15%]
. To connect to a production organization, click *Connect production org* from the *Connected Salesforce Orgs* dialog. 
+
The connection process restarts and enables you to connect to the production organization.
. To switch to another a sandbox for the connected production organization, click *Switch to this org* from the *Connected Salesforce Orgs* dialog.
. To connect to a sandbox organization that isn't connected, click *Connect*.
+
The connection process restarts and enables you to connect to the sandbox organization.
. To connect to a new sandbox organization, click *Connect new sandbox org*.
. To switch to another sandbox organization, click *Switch to this org*.

== Manage Orphaned Sandboxes
Orphan sandboxes occur when the connection to the production organization is disconnected and there are child sandbox organizations still connected. If you connected to a sandbox that isn't a child of the production organization, the sandbox appears as an orphan. You can still switch to this sandbox.

== Manage Refreshed Sandbox Connections
Refreshing a sandbox updates the metadata from the source organization. If a sandbox refreshes after the production organization is connected, reconnect to switch to this sandbox.

If a sandbox refreshes before the production organization is connected, switch to this sandbox.


== Delete Sandbox Organizations 

To delete a sandbox organizaton, see https://help.salesforce.com/s/articleView?id=000383260&type=1[Delete a sandbox] from the Salesforce documentation.

== Promoting a Sandbox to Production
When a portal is tested in a sandbox environment and is ready for production, deploy a subset of the Salesforce metadata using your CI/CD pipeline to production. Afterward, connect to the production instance with the subset of the Salesforce metadata to complete the installation and start curating APIs.

=== Before You Begin
Ensure you have basic knowledge of the following:

* Version control systems (VCS), for example, Git 
* https://developer.salesforce.com/tools/salesforcecli[Salesforce CLI]  
* CI/CD pipeline concepts
* API portal created in a sandbox environment

=== Promote a Sandbox to Production

//. Configure API Experience Hub in the sandbox organization:
//.. Navigate to Anypoint Platform, enter your username and password, and then click *Sign in*.
//.. From Anypoint Platform, select *API Experience Hub*.
//.. Create a portal.
//.. Add assets to the portal.
//.. Preview your portal and add more customizations using Experience Builder.
//.. Publish your portal and test it.

Move all of the portal's styling and customizations from the sandbox organization to the production organization.

. Create a Git repository to store the API Experience Hub metadata:
.. https://docs.github.com/en/repositories/creating-and-managing-repositories/quickstart-for-repositories[Create a Git repository]. 
.. Clone it locally to your machine. 
.. https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_ws_create_new.htm[Create a SFDX project].
.. Create a manifest `package.xml` file in `./config`, for example:
+
[%collapsible]
====
[codeblock]
----
<?xml version="1.0" encoding="UTF-8"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
   <types>
       <members>homeroCompanyLogo</members>
       <members>homeroLoginBackground</members>
       <members>minionHomeBanner</members>
       <members>minionPageBanner</members>
       <name>ContentAsset</name>
   </types>
   <types>
       <members>API_Experience_Hub1_banner</members>
       <members>API_Experience_Hub1_logo</members>
       <name>StaticResource</name>
   </types>
   <types>
       <members>AEH</members>
       <members>AEH/API_Experience_Hub1_logo</members>
       <name>Document</name>
   </types>
   <types>
       <members>AEH</members>
       <members>AEH/ChangedPasswordEmailTemplate</members>
       <members>AEH/ForgotPasswordEmailTemplate</members>
       <members>AEH/NewMemberWelcomeEmailTemplate</members>
       <members>AEH/RejectedMemberEmailTemplate</members>
       <name>EmailTemplate</name>
   </types>
   <types>
       <members>AEHLetterhead</members>
       <name>Letterhead</name>
   </types>
   <types>
       <members>Anypoint</members>
       <members>AnypointDevx</members>
       <members>AnypointEu</members>
       <members>AnypointQax</members>
       <members>AnypointStgx</members>
       <members>ExchangeAssetIcons</members>
       <members>ExchangeAssetIconsDevx</members>
       <members>ExchangeAssetIconsEu</members>
       <members>ExchangeAssetIconsQax</members>
       <members>ExchangeAssetIconsStgx</members>
       <members>GStaticFonts</members>
       <members>GoogleFonts</members>
       <members>SegmentAPI</members>
       <members>SegmentCDN</members>
       <name>CspTrustedSite</name>
   </types>
   <types>
       <members>Anypoint</members>
       <members>AnypointDevx</members>
       <members>AnypointEu</members>
       <members>AnypointQax</members>
       <members>AnypointStgx</members>
       <members>ExchangeAssetIcons</members>
       <members>ExchangeAssetIconsDevx</members>
       <members>ExchangeAssetIconsEu</members>
       <members>ExchangeAssetIconsQax</members>
       <members>ExchangeAssetIconsStgx</members>
       <members>SegmentAPI</members>
       <name>RemoteSiteSetting</name>
   </types>
   <!--
   <types>
       <members>ExperienceBundle</members>
       <members>Communities</members>
       <name>Settings</name>
   </types>
   -->
   <types>
       <members>API_Experience_Hub_Manage_Networks</members>
       <name>PermissionSet</name>
   </types>
   <types>
       <members>API Experience Hub</members>
       <name>Network</name>
   </types>
   <types>
       <members>HTTP_API_Audience</members>
       <name>Audience</name>
   </types>
   <types>
       <members>API_Experience_Hub</members>
       <name>CustomSite</name>
   </types>
   <types>
       <members>API_Experience_Hub1</members>
       <name>ExperienceBundle</name>
   </types>
   <types>
       <members>AEH_Default_Navigation</members>
       <members>AEH_Default_User_Navigation</members>
       <name>NavigationMenu</name>
   </types>
   <types>
       <members>cbAPI_Experience_Hub</members>
       <name>NetworkBranding</name>
   </types>
   <!--
   <types>
       <members>API Experience Hub Member User</members>
       <name>Profile</name>
   </types>
   -->
   <version>60.0</version>
</Package>
----
====
.. In a VCS, create a development branch.
.. Download the metadata using the manifest created from the Salesforce sandbox organization. 
. Retrieve the metadata from the Salesforce sandbox organization using Salesforce CLI commands:
.. Log in to the Salesforce sandbox organization.
+
[codeblock]
----
sf auth web login --instance-url=https://<SANBOX-INSTANCE_URL> --alias sandboxOrg
----
.. Edit the `config/package.xml` file before retrieving the metadata from the sandbox organization to retrieve the new metadata that you added.
+
Your sandbox organization can contain a large amount of metadata from different products because it's a copy from the Salesforce production organization. API Experience Hub is a subset of it and it's specified in the `config/package.xml` file that was created when creating the Git repository in a previous step. 
+
.. If the portal contains branding images, add them in `ContentAsset` section in the `config/package.xml`. For example:
+
[codeblock]
----
...
<types>
    <members>homeroCompanyLogo</members>
    <members>homeroLoginBackground</members>
    <members>minionHomeBanner</members>
    <members>minionPageBanner</members>
    <name>ContentAsset</name>
</types>
...
----

.. Review the metadata and retrieve it by running this command:
+
[codeblock]
----
sf project retrieve start --source-dir force-app --target-org sandboxOrg
----       
.. Confirm the metadata and commit all the metadata changes into the Git repository, 
or you can modify the `config/package.xml` and repeat the process if some metadata is missing or not necessary.
. Move the API Experience Hub portal from the sandbox organization to the production organization:
.. Log in to the production organization:
+
[codeblock]
----
sf auth web login --instance-url=https://<ENTERPRISE-INSTANCE_URL> --alias productionOrg
----
+
Before installing the API Experience Hub Manage package in your production organization, get the managed package version ID (SubscriberPackageVersionId) that's installed in the sandbox organization. 
+
.. Run the following command to get the managed package version ID. The `SubscriberPackageVersionId` field from the API Experience Hub managed package begins with *04t*:
+
[codeblock]
----
sf package installed list --target-org sandboxOrg --json
----
.. Install the API Experience Hub managed package in the production organization:
+ 
[codeblock]
----
sf package install --package 04t... --target-org productionOrg --no-prompt --wait 30
----
.. Deploy the API Experience Hub metadata to the production organization using Jenkins or other CI/CD tools to deploy the metadata into production, for example:
+
[codeblock]
----
sf project deploy start --source-dir force-app --target-org productionOrg
----
+
All configurations deploy in the production organization and now you're ready to connect this organization with API Experience Hub.
. Configure API Experience Hub in the production organization:
.. Navigate to Anypoint Platform, enter your username and password, and click *Sign in*.
.. From Anypoint Platform, select *API Experience Hub* from the list of products.
.. Connect the Salesforce production organization (Enterprise organization).
.. Click *Use existing portal* to reuse the portal that already exists.
.. From the *API Manage* page, add assets to the portal.
.. Click *Preview and publish your portal* to preview the portal.
.. Click *Publish*.


== See Also
* https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_ci.htm[Continuous Integration]
* https://developer.salesforce.com/docs/atlas.en-us.communities_dev.meta/communities_dev/networks_migrate_overview.htm[Deploy an Experirence Cloud Site from Sandbox to Production]
* https://developer.salesforce.com/docs/atlas.en-us.api_meta.meta/api_meta/meta_user_references.htm[Maintaining User References]
* xref:access-management::environments.adoc[]
* xref:setting-up-the-api-portal.adoc[]
